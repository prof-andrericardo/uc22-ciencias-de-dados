# 📘 UC22 – Aula 7 — Agrupamentos com `groupby()` (Pandas)

![Python](https://img.shields.io/badge/Python-3.11+-blue?logo=python)
![Pandas](https://img.shields.io/badge/Pandas-groupby-green?logo=pandas)
![Google Colab](https://img.shields.io/badge/Google%20Colab-Notebook-yellow?logo=googlecolab)
![Tempo](https://img.shields.io/badge/Dura%C3%A7%C3%A3o-90%20min-red)
![N%C3%ADvel](https://img.shields.io/badge/N%C3%ADvel-Iniciante%E2%9E%9CIntermedi%C3%A1rio-purple)

🎓 **Turma:** 3º Ano – Ensino Médio Técnico em Informática
📍 **Tema:** Agrupamentos e estatísticas por grupo com `groupby()`
🐍 **Ferramenta principal:** Google Colab

---

## ✨ Frase motivadora

> “Agrupar é comparar com contexto: só entendemos um valor quando olhamos o **grupo** ao redor.” – IAra 🧠

---

## 🎯 Objetivos de Aprendizagem

Ao final desta aula, você será capaz de:

- Usar `groupby()` para **agrupar por uma ou mais colunas**.
- Calcular **estatísticas** por grupo: `count`, `mean`, `sum`, `min`, `max`, `median`, `std`.
- Aplicar **agregações múltiplas** com `.agg({...})`.
- **Ordenar** e **formatar** resultados de agrupamentos.
- Criar **ranking por grupo** (top-N) com `nlargest`, `sort_values` e máscaras.
- (Opcional) **Gerar gráficos** a partir de resultados agregados.

---

## 📂 Preparação (Google Drive)

Usaremos os mesmos arquivos:

- `pokemons_pokedex.csv`
- `escolas_estaduais_censo_escolar_2023.csv`

```python
# 📂 Conectando o Google Drive
from google.colab import drive
drive.mount('/content/drive')

import pandas as pd

# Caminhos (ajuste conforme sua pasta no Drive)
caminho_poke = "/content/drive/MyDrive/UC22/pokemons_pokedex.csv"
caminho_escolas = "/content/drive/MyDrive/UC22/escolas_estaduais_censo_escolar_2023.csv"

# Leitura
df_poke = pd.read_csv(caminho_poke, encoding="utf-8")
df_escolas = pd.read_csv(caminho_escolas, encoding="latin-1", sep=",")

# Padronização de colunas
df_poke.columns    = df_poke.columns.str.strip().str.lower().str.replace(" ", "_", regex=False)
df_escolas.columns = df_escolas.columns.str.strip().str.lower().str.replace(" ", "_", regex=False)

# Ajuste opcional (texto)
if "no_municipio" in df_escolas.columns:
    df_escolas["no_municipio"] = df_escolas["no_municipio"].astype(str).str.strip().str.upper()

print("✅ Pokémon:", df_poke.shape, "colunas:", len(df_poke.columns))
print("✅ Escolas:", df_escolas.shape, "colunas:", len(df_escolas.columns))
```

---

## 1) O que é `groupby()`?

`groupby()` agrupa linhas que têm o **mesmo valor** em uma (ou mais) colunas e permite calcular **estatísticas por grupo**.

- Ex.: média de `attack` por `type_1`;
- contagem de escolas por `no_municipio`;
- soma de HP por tipo; etc.

### Exemplo básico — média por tipo

```python
# 🎯 Média de atributos por type_1 (Pokémon)
media_por_tipo = df_poke.groupby('type_1')[['attack','defense','speed','hp']].mean().round(2)
media_por_tipo.head(10)
```

---

## 2) Funções de agregação comuns

- `count()` – quantidade
- `mean()` – média
- `sum()` – soma
- `min()` / `max()` – menor/maior
- `median()` – mediana
- `std()` – desvio padrão

### Exemplo — várias métricas

```python
agr = df_poke.groupby('type_1').agg(
    qtd=('name', 'count'),
    media_atk=('attack', 'mean'),
    media_def=('defense', 'mean'),
    media_spd=('speed', 'mean'),
    media_hp=('hp', 'mean'),
    atk_max=('attack', 'max'),
    spd_max=('speed', 'max')
).round(2)

# Ordenar pelo ataque médio (desc)
agr.sort_values('media_atk', ascending=False).head(10)
```

---

## 3) Agrupar por **múltiplas colunas**

```python
# 🎯 Média de Attack por combinação de (type_1, generation) – ajuste o nome da coluna se existir 'generation'
col_gen = 'generation' if 'generation' in df_poke.columns else None

if col_gen:
    media_tipo_gen = df_poke.groupby(['type_1', col_gen])['attack'].mean().round(2)
    media_tipo_gen.head(10)
else:
    print("⚠️ Coluna 'generation' não encontrada; pulando exemplo 3.")
```

---

## 4) Selecionar os **Top-N por grupo**

Há várias estratégias. Duas clássicas:

### 4.1) Ordenar e pegar a cabeça de cada grupo

```python
# 🎯 Top 5 Pokémon por 'attack' dentro de cada type_1
# 1) Ordenamos por type_1 (asc) e attack (desc)
# 2) Em seguida usamos groupby + head(5) para pegar os 5 primeiros de cada grupo

top5_por_tipo = (
    df_poke
      .sort_values(['type_1','attack'], ascending=[True, False])
      .groupby('type_1')
      .head(5)[['name','type_1','attack','defense','speed']]
)
top5_por_tipo.head(15)
```

### 4.2) `nlargest` por grupo (quando focamos em **uma** métrica)

```python
# 🎯 Top 3 por 'speed' em cada type_1
# Estratégia: aplicar um groupby + apply(nlargest)

top3_speed_tipo = (
    df_poke.groupby('type_1', group_keys=False)
           .apply(lambda g: g.nlargest(3, 'speed'))[['name','type_1','speed','attack']]
)
top3_speed_tipo.head(12)
```

---

## 5) Formatação e renomeação de colunas resultantes

```python
# 🎯 Deixar a tabela "linda" para ler: renomear, ordenar colunas e índices

tabela = (
    df_poke.groupby('type_1')
           .agg(qtd=('name','count'),
                atk_med=('attack','mean'),
                def_med=('defense','mean'),
                spd_med=('speed','mean'),
                hp_med=('hp','mean'))
           .round(1)
           .sort_values(['atk_med','spd_med'], ascending=[False, False])
)
tabela.reset_index().head(10)
```

---

## 6) (Opcional) Gráficos a partir de agregações

> Sem estilização extra (mantendo o padrão das aulas): um gráfico simples ajuda a visualizar.

```python
import matplotlib.pyplot as plt

# 🎯 Barras: quantidade de Pokémon por tipo (Top 10)
contagem_tipo = df_poke['type_1'].value_counts().head(10)
ax = contagem_tipo.plot(kind='bar', figsize=(8,4))
ax.set_title('Top 10 tipos por quantidade de Pokémon')
ax.set_xlabel('type_1')
ax.set_ylabel('Quantidade')
plt.tight_layout()
plt.show()
```

---

## 7) Aplicando `groupby()` no dataset de Escolas

```python
# 🎯 7.1 Contagem de escolas por município (Top 10)
if 'no_municipio' in df_escolas.columns:
    top10_mun = df_escolas['no_municipio'].value_counts().head(10)
    top10_mun

# 🎯 7.2 Agrupar por dependência administrativa (se existir)
if 'tp_dependencia' in df_escolas.columns:
    dep = df_escolas.groupby('tp_dependencia')['no_entidade'].count().sort_values(ascending=False)
    dep
```

---

## ✅ Checklist — Hoje você aprendeu

- `groupby()` por 1 ou N colunas.
- Estatísticas com `agg()` e agregações múltiplas.
- Ordenar, formatar e **escolher Top-N por grupo**.
- (Opcional) Gerar gráficos simples a partir de agregações.
- Aplicar a mesma lógica em datasets diferentes (Pokémon e Escolas).

---

## 🧪 Mini-Lab (para entregar no Classroom)

**Arquivo:** `UC22_Aula07_Pratica_SeuNome.ipynb`

### Parte 1 — Pokémon

1. **Médias por tipo:** Crie uma tabela com `qtd`, `atk_med`, `def_med`, `spd_med`, `hp_med` por `type_1` (arredonde para 2 casas) e **ordene** por `atk_med` (desc) e `spd_med` (desc).
2. **Top 5 ataque por tipo:** Liste os **5 Pokémon com maior `attack`** dentro de cada `type_1` (mostre `name`, `type_1`, `attack`, `speed`).
3. **Top 3 velocidade por tipo:** Usando `nlargest`, retorne os **3 mais rápidos** por `type_1`.
4. **Médias por (type_1, generation)** – se existir `generation`: média de `attack` e `speed` por par `(type_1, generation)`.

### Parte 2 — Escolas

1. **Top 10 municípios:** Mostre os 10 municípios com **maior número de escolas**.
2. **Dependência administrativa:** Agrupe por `tp_dependencia` e mostre a contagem de escolas (ordem desc).

> **Dica:** Use `.reset_index()` quando precisar transformar o índice em coluna para ordenar/formatar.

---

## 🧯 Erros comuns

- **Esquecer colunas numéricas** em `agg()` → confira `df.dtypes`.
- **Nome de coluna incorreto** → revise com `df.columns`.
- **MultiIndex confuso** após agrupar por várias colunas → use `.reset_index()`.
- **Ordenar antes de `groupby().head(N)`** é essencial para “Top-N por grupo”.
- **`nlargest` exige coluna numérica** e não aceita valores `object`.

---

## 📎 Conclusão

Você aprendeu a **comparar grupos** e extrair **insights** com `groupby()`.
Isso nos permite responder perguntas como:

- Quais tipos têm **maior ataque médio**?
- Quais **Pokémon mais rápidos** em cada tipo?
- Quais municípios concentram **mais escolas**?

🔮 **Próxima aula (8):** **Ordenação com `sort_values()`** e **rankings globais**, conectando com os agrupamentos para criar **dashboards simples**.
